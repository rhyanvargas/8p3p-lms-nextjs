name: PR Quality Checks

on:
  pull_request:
    branches: [main, dev]

jobs:
  quality-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint checks
        run: npm run lint:strict

      - name: Create mock amplify_outputs.json for CI
        run: |
          if [ ! -f "amplify_outputs.json" ]; then
            echo "Creating mock amplify_outputs.json for CI build..."
            cat > amplify_outputs.json << 'EOF'
          {
            "auth": {
              "aws_region": "us-east-1",
              "user_pool_id": "mock-pool-id",
              "user_pool_client_id": "mock-client-id",
              "identity_pool_id": "mock-identity-pool-id"
            },
            "data": {
              "aws_region": "us-east-1",
              "url": "https://mock-api.amazonaws.com/graphql"
            }
          }
          EOF
          fi

      - name: Run TypeScript check
        run: npm run type-check

      - name: Run build check (with mock amplify outputs)
        run: |
          echo "🏗️ Testing build with mock Amplify configuration..."
          npm run build
        continue-on-error: false

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lint-logs
          path: |
            npm-debug.log*
            yarn-debug.log*
            yarn-error.log*
